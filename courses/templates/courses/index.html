{% extends "users/base.html" %}
{% load static %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        {% for course in course_list %}
        <!-- Card {{ forloop.counter }} -->
        <div class="col-md-3 mb-3">
            <div class="card">
                <img src="{{ course.image.url }}" class="card-img-top" alt="{{ course.name }}">
                <div class="card-body">
                    <h5 class="card-title">{{ course.name }}</h5>
                    <p class="card-text">Duracion: {{ course.hours }} horas en {{ course.duration }} {% if course.duration == 1 %}mes{% else %}meses{% endif %}</p>
                    {% if user.is_authenticated %}<button onclick="generate('{{ course.name }}', '{{ course.hours }}')" class="btn btn-primary">Generar
                        certificado</button>{% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.40.2/docxtemplater.js"></script>
<script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/1.3.8/FileSaver.js"></script>
<script src="https://unpkg.com/pizzip@3.1.4/dist/pizzip-utils.js"></script>
<script>
    function loadFile(url, callback) {
        PizZipUtils.getBinaryContent(url, callback);
    }
    window.generate = function generate(course, hours) {
        loadFile(
            {% comment %} "https://docxtemplater.com/tag-example.docx", {% endcomment %}
           "{% static "certificate-template.docx" %}",
            function (error, content) {
                if (error) {
                    throw error;
                }
                const zip = new PizZip(content);
                const doc = new window.docxtemplater(zip, {
                    paragraphLoop: true,
                    linebreaks: true,
                });

                // Render the document (Replace {first_name} by John, {last_name} by Doe, ...)
                doc.render({
                    full_name: "{{ user.last_name }}, {{ user.first_name }}",
                    course_name: course,
                    n_horas: hours,
                });

                const blob = doc.getZip().generate({
                    type: "blob",
                    mimeType:
                        "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
                    // compression: DEFLATE adds a compression step.
                    // For a 50MB output document, expect 500ms additional CPU time
                    compression: "DEFLATE",
                });
                // Output the document using Data-URI
                saveAs(blob, "{{ user.last_name }}, {{ user.first_name }}");
            }
        );
    };
</script>
{% endblock content %}